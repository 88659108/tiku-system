<extend name="Common:main-page" />

<block name="page-meta">
<title>知识点管理</title>
<meta name="keywords" content="" />
<meta name="description" content=""/>
</block>


<block name="page-header">

</block>

<block name="page-breadcrumb">
<li class="active">教学专区</li>
</block>

<block name="page-search"></block>
<block name="page-settings-container"></block>
<block name="page-navigation"></block>


<block name="page-content">
    <div class="row">
    	<div class="col-xs-12">
        
        
<div class="widget-box transparent">
											<div class="widget-header widget-header-flat">
												<div class="lighter row">
                                                	<div class="col-sm-2">
                                                    <select class="form-control js-select-block" data-placeholder="选择一个父级知识点...">
																<option value="0">一级根知识点</option>
																<volist name="form_list" id="cls">
                                                                	<option value="{$cls.id}">{$cls.title}</option>
                                                                    <volist name="cls['list']" id="clss">
                                                                		<option value="{$clss.id}">&nbsp;&nbsp;&nbsp;&nbsp;{$clss.title}</option>
                                                                		<volist name="clss['list']" id="clsss">
                                                                            <option value="{$clsss.id}">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$clsss.title}</option>
                                                                        </volist>
                                                                    
                                                                    </volist>
                                                                </volist>
															</select>

                                                    
                                                    </div>
                                                    <div class="input-group col-sm-8">
																	<input type="text" data-rel="tooltip" data-placement="top" class="form-control js-search-query tooltip-error" placeholder=" 知识点,知识点,知识点名称" data-original-title="空格 或 ','号 隔开可以添加多个">
																	<span class="input-group-btn">
																		<button type="button" class="btn btn-danger btn-sm js-btn-insert-block">
																			添加知识点
																			<i class="icon-gift icon-on-right bigger-110"></i>
																		</button>
                                                                        <button class="btn btn-success btn-sm js-btn-list-class" type="button">
																			批量更新类别
																			<i class="icon-bell-alt icon-on-right bigger-110"></i>
																		</button>
                                                                        <button class="btn btn-purple btn-sm js-btn-list-rank" type="button">
																			批量更新排序
																			<i class="icon-bell-alt icon-on-right bigger-110"></i>
																		</button>
                                                                        <button class="btn btn-grey btn-sm js-btn-list-delete" type="button">
																			批量删除类别
																			<i class="icon-bell-alt icon-on-right bigger-110"></i>
																		</button>
                                                                        <button class="btn btn-primary btn-sm js-btn-info-block" style="display:none;" type="button">
																			<span>更新《....》</span>
																			<i class="icon-bell-alt icon-on-right bigger-110"></i>
																		</button>
																	</span>
																</div>
                                                                
                                                                <div class="col-sm-2 js-msg-box"></div>
                                                    
                                                    
												</div>
                                                
											</div></div>  
        
        
        
        
        
        
        
   
<volist name="cls_list" id="cls">  
<br /> 
<div class="widget-box transparent js-class-row-box" dataid="{$cls.id}">
											<div class="widget-header widget-header-flat">
												<h2 class="lighter">
													<i class="icon-gift primary"></i> <span class="js-class-block-{$cls.id}">{$cls.id} {$cls.title}({$cls.id|get_question_count=1})</span>
												</h2>

												<div class="widget-toolbar">
													<a href="#!" data-action="collapse">
														<i class="icon-chevron-up"></i>
													</a>
												</div>
                                                
                                                
<div class="widget-toolbar no-border">
<div class="action-buttons" style="display:none;">
                                                                        
																		<a href="#" class="blue">
																			<i class="icon-pencil bigger-130 js-btn-class-edit" dataid="{$cls.id}" topid="{$cls.topid}"></i>
																		</a>

																		<span class="vbar"></span>

																		<a href="#!" class="red js-btn-class-max-delete" dataid="{$cls.id}">
																			<i class="icon-trash bigger-130"></i>
																		</a>

																		<span class="vbar"></span>

																		<a href="#!" class="green">
																			<i class="icon-flag bigger-130"></i>
																		</a>
</div>
</div>  
                                                
                                                
                                                
											</div>

											<div class="widget-body">
                                            <div class="widget-body-inner" style="display: block;">
												<div class="widget-main no-padding">
													
                                                    
                                                    
                                                    
<volist name="cls['list']" id="clss">    
<br /> 
<div class="widget-box transparent collapsed js-class-row-box" dataid="{$clss.id}">   
<div class="widget-header widget-header-flat">
												<h3 class="lighter text-danger">
													<i class="icon-bell-alt orange"></i> <span class="js-class-block-{$clss.id}">{$clss.id} {$clss.title}({$clss.id|get_question_count=2})</span>
												</h3>
                                                <div class="widget-toolbar">
                                                	<a href="#!" data-action="collapse">
                                                		<i class="icon-chevron-down"></i>
                                               		</a>
												</div>
<div class="widget-toolbar no-border">
<div class="action-buttons" style="display:none;">
                                                                        
																		<a href="#" class="blue">
																			<i class="icon-pencil bigger-130 js-btn-class-edit" dataid="{$clss.id}" topid="{$clss.topid}"></i>
																		</a>

																		<span class="vbar"></span>

																		<a href="#!" class="red js-btn-class-max-delete" dataid="{$clss.id}">
																			<i class="icon-trash bigger-130"></i>
																		</a>

																		<span class="vbar"></span>

																		<a href="#!" class="green">
																			<i class="icon-flag bigger-130"></i>
																		</a>
</div>
</div>
                                                    
                                                    
												
											</div>
<div class="widget-body">
                                            <div class="widget-body-inner" style="display: none;">
												<div class="widget-main no-padding">                                         
<table class="table table-striped table-hover table-bordered">
	<thead>
													<tr>
														<th class="center" style="width:40px;">
															<label>
																<input type="checkbox" class="ace js-checkbox-all">
																<span class="lbl"></span>
															</label>
														</th>
														<th style="width:240px;" class="text-danger">
                                                        名称</th>
                                                        <th class="text-danger">
														教学课件
                                                        </th>
														<th class="text-danger">示例试题</th>
														<th class="text-danger">课后作业</th>
														<th class="text-danger">评测卷</th>
														<th class="text-danger">试题咨询</th>
														<th class="text-danger">错题讨论区</th>
														<th class="text-danger">智能分析</th>
														<th class="text-danger" style="width:60px;">开关</th>
														<th class="text-danger" style="width:100px;">Action</th>
                                                        <th class="text-danger" style="width:70px;">
                                                        排序</th>
													</tr>
												</thead>											

												<tbody>
                                                <volist name="clss['list']" id="clsss"> 
													<tr class="js-class-row-box" dataid="{$clsss.id}">
														<td class="center">
															<label>
																<input type="checkbox" class="ace js-checkbox-li" dataid="{$clsss.id}">
																<span class="lbl"></span>
															</label>
														</td>

														<td><h4 class="js-class-block-{$clsss.id}">{$clsss.id} {$clsss.title}({$clsss.id|get_question_count=3})</h4></td>
                                          
														<td><button class="btn btn-app radius-5 btn-sm"><i class="icon-desktop"></i></button></td>
														<td><button class="btn btn-app radius-5 btn-sm"><i class="icon-leaf"></i><span class="badge badge-success">+3</span></button></td>
														<td><button class="btn btn-success btn-app radius-5 btn-sm"><i class="icon-book"></i><span class="badge badge-success">+3</span></button></td>

														<td><button class="btn btn btn-success btn-app radius-5 btn-sm"><i class="icon-list"></i><span class="badge badge-success">+3</span></button></td>
														<td><button class="btn btn-pink btn-app radius-5 btn-sm"><i class="icon-group"></i><span class="badge badge-warning">+3</span></button></td>
                                                        <td><button class="btn btn-pink btn-app radius-5 btn-sm"><i class="icon-comments"></i><span class="badge badge-warning">+3</span></button></td>
                                                        <td><button class="btn btn-info btn-app radius-5 btn-sm"><i class="icon-bar-chart"></i></button></td>
                                                        <td><br />
                                                        <label>
                                                            <input <eq name="clsss.status" value="1"> checked="checked"</eq> dataid="{$clsss.id}" class="ace ace-switch js-btn-class-switch" type="checkbox" />
                                                            <span class="lbl"></span>
                                                        </label>
                                                        </td>
														<td><br />
                                                        <div class="visible-md visible-lg hidden-sm hidden-xs btn-group">
																<button class="btn btn-xs btn-info tooltip-info js-btn-class-refresh" data-rel="tooltip" title="" data-original-title="更新">
																	<i class="icon-refresh bigger-120"></i>
																</button>
                                                                
                                                               
																
															</div>

															<div class="visible-xs visible-sm hidden-md">
																<div class="inline position-relative">
																	<button class="btn btn-minier dropdown-toggle" data-toggle="dropdown">
																		<i class="icon-cog bigger-110"></i>
																	</button>

																	<ul class="dropdown-menu dropdown-only-icon dropdown-yellow pull-right dropdown-caret dropdown-close">
                                                                    <li>
																			<a href="#" class="tooltip-success" data-rel="tooltip" title="" data-original-title="修改">
                                                                            	
																				<span class="text-success js-btn-class-edit" dataid="{$clsss.id}" topid="{$clsss.topid}">
																					<i class="icon-edit bigger-120"></i>
                                                                                    修改
																				</span>
																			</a>
																		</li>
																		<li>
																			<a href="#!" dataid="{$clsss.id}" class="tooltip-error js-btn-class-delete" data-rel="tooltip" title="" data-original-title="彻底删除">
                                                                            	
																				<span class="red">
																					<i class="icon-trash bigger-120"></i>
                                                                                    删除
																				</span>
																			</a>
																		</li>
																	</ul>
																</div>
															</div>
														</td>
														<td><br />
														<input type="text" value="{$clsss.rank}" class="input-mini cls-spinner" dataid="{$clsss.id}" />
 														</td>  
													</tr>
                                                    
                                                    <tr>
                                                    <td></td>
                                                    <td align="right"><h4>》 考点标签：</h4></td>
                                                    <td colspan="10"> 
                                                    <foreach name="clsss['list']" item="clssss" >
              <label><input type="checkbox">{$clssss.id} {$clssss.title}</label> &nbsp;&nbsp;&nbsp;&nbsp;
                                                    </foreach>
                                                    </td>
                                                    </tr>
                                                    
                                                    <tr>
                                                    <td colspan="12"></td>
                                                    </tr>
</volist>
													

												</tbody>
											</table>   
</div>   </div></div></div>                                                                 
</volist>     
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
                                                    
												</div><!-- /widget-main -->
											</div></div><!-- /widget-body -->
										</div> <br /> 
</volist>
        
        
        
        
        
        
        
        

        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        
        </div>
    	<!-- /.col -->
    </div><!-- /.row -->
</block>

<block name="page-footer">
<js href="__BOOTSTRAP__js/fuelux/fuelux.spinner.min.js" />



<script language="javascript">


$('.cls-spinner').ace_spinner({value:0,min:0,step:1, btn_up_class:'btn-info', btn_down_class:'btn-info'})
				.on('change', function(){
					var dataid	= $(this).attr('dataid');
					var obj	= $(".js-btn-class-switch[dataid='"+dataid+"']");
						obj.attr('rank', this.value);
				});

$('[data-rel=tooltip]').tooltip();

				
				
$('.widget-header').hover(

	function(){
		$(this).find('.action-buttons').show();
	}, 
	function(){
		$(this).find('.action-buttons').hide();
});				



//添加知识点
$('.js-btn-insert-block').click(function(){
	
	var block	= $('.js-select-block');
	var topid	= block.find('option:selected').val();
	
	var input	= $('.js-search-query');
	var text	= input.val();
	
	var msgobj	= $('.js-msg-box');
	var btn		= $(this);
		btn.addClass('disabled');
		msgobj.html('<i class="icon-spinner icon-spin orange bigger-125"></i> <span class="text-muted"> 正在努力保存中..</span>');
	$.ajax({
		url:'Edu/insertblock',
		type:'POST',
		data:'topid=' + topid + '&text=' + text,
		dataType:'json',
		success:function(json){
			btn.removeClass('disabled');
			
			if(json.status == 1){
				input.val('');
				msgobj.html('<i class="icon-ok bigger-110 green"></i> <span class="text-success"> 成功添加知识点..</span>');
				return;	
			}
			
			msgobj.show();
			setTimeout(function(){ msgobj.hide(); }, 3000);
			if(json.status == -1){
				msgobj.html('<i class="icon-warning-sign orange bigger-125"></i> <span class="text-warning"> '+ json.msg +'</span>');
				return;	
			}
			
			msgobj.html('<i class="icon-warning-sign orange bigger-125"></i> <span class="text-warning"> 喵了个咪,发生错误..</span>');
		}
	});
	
});

//编辑单个知识点
$('.js-btn-info-block').click(function(){
	
	var dataid	= $(this).attr('dataid');
	if(!dataid) return false;	
	
	var block	= $('.js-select-block');
	var topid	= block.find('option:selected').val();
	
	var input	= $('.js-search-query');
	var text	= input.val();
	
	var msgobj	= $('.js-msg-box');
	var btn		= $(this);
		btn.addClass('disabled');
		msgobj.html('<i class="icon-spinner icon-spin orange bigger-125"></i> <span class="text-muted"> 正在努力更新中..</span>');
		
	$.ajax({
		url:'Edu/updateblock',
		type:'POST',
		data:'topid=' + topid + '&text=' + text + '&dataid=' + dataid,
		dataType:'json',
		success:function(json){
			
			if(json.status == 1){
				input.val('');
				setTimeout(function(){ btn.hide(); }, 3000);
				$('.js-class-block-' + dataid).text(text);
				msgobj.html('<i class="icon-ok bigger-110 green"></i> <span class="text-success"> 成功更新知识点《'+text+'》..</span>');
				return;	
			}
			
			btn.removeClass('disabled');
			msgobj.show();
			setTimeout(function(){ msgobj.hide(); }, 3000);
			if(json.status == -1){
				msgobj.html('<i class="icon-warning-sign orange bigger-125"></i> <span class="text-warning"> '+ json.msg +'</span>');
				return;	
			}
			
			msgobj.html('<i class="icon-warning-sign orange bigger-125"></i> <span class="text-warning"> 喵了个咪,发生错误..</span>');
		}
	});	
});


//将知识点设置到编辑状态
$('.js-btn-class-edit').click(function(){
	
	var dataid	= $(this).attr('dataid');
	var topid	= $(this).attr('topid');
	
	var block	= $('.js-select-block');
		block.val(topid);
	
	var text	= $('.js-class-block-' + dataid).text();
	var input	= $('.js-search-query');
		input.val(text);
		
	var btn		= $('.js-btn-info-block');
		btn.find('span').html('更新《'+text+'》');
		btn.attr('dataid', dataid).show();	
		
});


//批量更新排序
$('.js-btn-list-rank').click(function(){
	
	var list	= $('.js-btn-class-switch[rank]');
	if(list.size() == 0){
		var msgobj	= $('.js-msg-box');
			msgobj.show();
		setTimeout(function(){ msgobj.hide(); }, 3000);
		msgobj.html('<i class="icon-warning-sign orange bigger-125"></i> <span class="text-warning"> 排序不需要更新..</span>');
	}
	
	//批量排序
	list.each(function(index, element) {
        var dataid	= $(this).attr('dataid');
		var rank	= $(this).attr('rank');
		var status	= ($(this).prop("checked")) ? 1 : 0;
		
		var btnobj	= $(this);
		$.ajax({
		url:'Edu/updateblocks',
		type:'POST',
		data:'status=' + status + '&rank=' + rank + '&dataid=' + dataid + '&mode=rank',
		dataType:'json',
		success:function(json){
			
			var obj = $('.js-class-block-' + dataid).parent('td');
			setTimeout(function(){ obj.find('.js-class-msg').remove();  }, 3000);
			
			if(json.status == 1){
				btnobj.removeAttr('rank');
				obj.append('<span class="js-class-msg"><i class="icon-ok bigger-110 green"></i></span>');
				return;
			}
			
			if(json.status == -1){
				obj.append('<span class="js-class-msg"><i class="text-warning bigger-110 orange"></i></span>');
				return;
			}
			
			obj.append('<span class="js-class-msg"><i class="icon-remove bigger-110 red"></i></span>');
		}});
    });
	
});


//批量更新分类
$('.js-btn-list-class').click(function(){
	
	//批量转分类
	var list	= $('.js-checkbox-li:checked');
	if(list.size() == 0){
		var msgobj	= $('.js-msg-box');
			msgobj.show();
		setTimeout(function(){ msgobj.hide(); }, 3000);
		msgobj.html('<i class="icon-warning-sign orange bigger-125"></i> <span class="text-warning"> 没有选择知识点..</span>');
	}
	
	var block	= $('.js-select-block');
	var topid	= block.find('option:selected').val();
	list.each(function(index, element) {
        var dataid	= $(this).attr('dataid');
		
		var btnobj	= $(this);
		$.ajax({
		url:'Edu/updateblocks',
		type:'POST',
		data:'topid=' + topid + '&dataid=' + dataid + '&mode=class',
		dataType:'json',
		success:function(json){
			
			var obj = $('.js-class-block-' + dataid).parent('td');
			setTimeout(function(){ obj.find('.js-class-msg').empty();  }, 3000);
			
			if(json.status == 1){
				btnobj.prop('checked', false);
				obj.append('<span class="js-class-msg"><i class="icon-circle green"></i></span>');
				return;
			}
			
			if(json.status == -1){
				obj.append('<span class="js-class-msg"><i class="text-warning bigger-110 orange"></i></span>');
				return;
			}
			
			obj.append('<span class="js-class-msg"><i class="icon-remove bigger-110 red"></i></span>');
			
		}});
    });	
	
});


//批量删除分类
$('.js-btn-list-delete').click(function(){
	
	var msgobj	= $('.js-msg-box');
	var list	= $('.js-checkbox-li:checked');
	if(list.size() == 0){
		msgobj.show();
		setTimeout(function(){ msgobj.hide(); }, 3000);
		msgobj.html('<i class="icon-warning-sign orange bigger-125"></i> <span class="text-warning"> 没有选择知识点..</span>');
	}
	
	var ids	= [];
	list.each(function(index, element) {
        ids.push($(this).attr('dataid'));
	});
	
	delete_all_blocks(ids);
});


//根据数组ids删除知识点
function delete_all_blocks(ids){

	var msgobj	= $('.js-msg-box');
	$.ajax({
		url:'Edu/deleteblocks',
		type:'POST',
		data:'ids=' + ids.join(','),
		dataType:'json',
		success:function(json){
			
			msgobj.show();
			setTimeout(function(){ msgobj.hide(); }, 3000);
			
			if(json.status == 1){
				
				//删除节点
				for(var i = 0 in ids){
					$('.js-class-row-box[dataid='+ids[i]+']').remove();
				}
				
				msgobj.html('<i class="icon-ok bigger-110 green"></i> <span class="text-success"> 成功删除知识点..</span>');
				return;
			}
			
			if(json.status == -1){
				msgobj.html('<i class="icon-warning-sign orange bigger-125"></i> <span class="text-warning"> 没有选择知识点..</span>');
				return;
			}
			
			msgobj.html('<i class="icon-warning-sign orange bigger-125"></i> <span class="text-warning"> 喵了个咪,发生错误..</span>');
			
	}});
}

//删除单个知识点
$('.js-btn-class-delete').click(function(){
	
	var dataid	= $(this).attr('dataid');
	$('.js-checkbox-li[dataid='+dataid+']').prop('checked', true);
	$('.js-btn-list-delete').click();
});


$('.js-btn-class-refresh').click(function(){
	$('.js-btn-list-rank').click();
});


//删除一级,二级知识点
$('.js-btn-class-max-delete').click(function(){
	
	var dataid	= $(this).attr('dataid');
	var box		= $(this).parents('.js-class-row-box[dataid='+dataid+']');
	var list	= box.find('.js-class-row-box');
	if(list.size() > 0){
		alert('该知识点存在下级,不能删除..');
		return;	
	}
	
	//执行删除
	delete_all_blocks(Array(dataid));
});


//分组选中
$('.js-checkbox-all').click(function(){
	
	var box	= $(this).parents('.table');
		box.find('.js-checkbox-li').prop('checked', function( i, val) { return !val; });
	
});

//设置状态
$('.js-btn-class-switch').click(function(){
	
	var dataid	= $(this).attr('dataid');
	var rank	= $('.cls-spinner[dataid='+dataid+']').val();
	
	$(this).attr('rank', rank);
	$('.js-btn-list-rank').click();
});
</script>

</block>